# 11.6 — Analytics / Reporting (hardware + occupancy) [Week 5–6]

This phase adds **operator-grade reporting**: sensor performance rankings, gateway overview, a first Network Overview, and export/scheduling scaffolding.

## What we shipped

### Sensor performance reports
- API: `GET /api/portal/reports/sensors`
  - Rankings ordered by critical alerts → open alerts → flapping → events
  - Period comparison: current range vs previous equal-length range
  - CSV export: `?format=csv`
- UI: `/portal/reports/sensors`

### Gateway units overview + coverage panels
- API: `GET /api/portal/reports/gateways`
  - Units list with events/24h, unique sensors/24h, avg RSSI/SNR
  - Coverage panels: by site + backhaul distribution
  - CSV export: `?format=csv`
- UI: `/portal/reports/gateways`

### Network overview (optional MVP)
- API: `GET /api/portal/reports/network`
  - Nodes: sites, gateways, sensors
  - Links: gateway → sensor (last 24h traffic)
- UI: `/portal/reports/network`

### Exports + scheduled reports (cron-ready)
- DB models:
  - `report_subscriptions`
  - `report_deliveries`
- Admin API:
  - `GET/POST /api/portal/admin/reports/subscriptions`
  - `PATCH/DELETE /api/portal/admin/reports/subscriptions/[id]`
- Cron endpoint (logs deliveries only; email integration later):
  - `GET /api/cron/reports` (protected by `CRON_SECRET`)

## Key files

- APIs:
  - `app/api/portal/reports/sensors/route.ts`
  - `app/api/portal/reports/gateways/route.ts`
  - `app/api/portal/reports/network/route.ts`
  - `app/api/portal/admin/reports/subscriptions/route.ts`
  - `app/api/portal/admin/reports/subscriptions/[id]/route.ts`
  - `app/api/cron/reports/route.ts`

- UI:
  - `app/portal/reports/sensors/page.tsx`
  - `app/portal/reports/sensors/SensorReportsClient.tsx`
  - `app/portal/reports/gateways/page.tsx`
  - `app/portal/reports/gateways/GatewayReportsClient.tsx`
  - `app/portal/reports/network/page.tsx`
  - `app/portal/reports/network/NetworkOverviewClient.tsx`

## Apply / verify

```bash
cd /Users/vadimkus/VisionDrive
npm run db:push
npm run build
```

Open:
- `/portal/reports/sensors`
- `/portal/reports/gateways`
- `/portal/reports/network`

Exports:
- `/api/portal/reports/sensors?format=csv`
- `/api/portal/reports/gateways?format=csv`

## Notes / next upgrades

- Add proper charting (sparklines + trend charts) for period comparisons.
- Add gateway coverage map (radius/heat) once we store gateway positions + site polygons consistently.
- Add real email sending for scheduled reports (SendGrid/Resend) and attach CSV/links.


