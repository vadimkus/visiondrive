# 11.7 — Finance (Master Admin)

## What was implemented

### 1) Expenses tracking (Master Admin)
- DB table: `expenses`
  - fields: category, vendor, description, amountCents, currency, occurredAt, (optional) tenantId
- APIs (Master Admin only):
  - `GET /api/portal/admin/finance/expenses?tenantId=all&start=...&end=...`
  - `POST /api/portal/admin/finance/expenses`
  - `PATCH /api/portal/admin/finance/expenses/[id]`
  - `DELETE /api/portal/admin/finance/expenses/[id]`

### 2) Stripe billing metrics ingestion (SDK-free)
- DB tables:
  - `billing_events` (raw Stripe events + extracted amounts)
  - `billing_subscriptions` (subscription snapshot + computed monthly MRR)
- Webhook endpoint:
  - `POST /api/webhooks/stripe`
  - signature verification implemented in `lib/stripe-webhook.ts`

Env vars:
- `STRIPE_WEBHOOK_SECRET` (required)

Tenant attribution:
- If Stripe objects include `metadata.tenantId`, the webhook stores that on `billing_events.tenantId` and `billing_subscriptions.tenantId`.
- Otherwise the records are stored with `tenantId = NULL` (global revenue).

### 3) Finance dashboard UI
- Page: `/portal/admin/finance` (Master Admin only)
- Features:
  - tenant filter (All + tenants)
  - date range filter
  - KPIs: net revenue, expenses, profit, MRR/ARR, churn
  - expenses table + add expense form
  - billing events table (populates once webhooks arrive)

## How to connect Stripe

1) In Stripe Dashboard → Developers → Webhooks → **Add endpoint**
- URL: `<YOUR_DOMAIN>/api/webhooks/stripe`
- Events to enable (minimum):
  - `invoice.paid`
  - `invoice.payment_failed`
  - `customer.subscription.created`
  - `customer.subscription.updated`
  - `customer.subscription.deleted`
  - `charge.refunded`
  - `checkout.session.completed` (optional)

2) Copy the Signing secret and set:
- `STRIPE_WEBHOOK_SECRET=whsec_...`

3) Verify
- Visit `/portal/admin/finance`
- Trigger a test event from Stripe webhook page → confirm `billing_events` populates and KPIs change.



