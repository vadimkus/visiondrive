# 11.3.1 Zone selector + deterministic demo seed + KPI clarity

This document captures the follow-up work added after Phase **11.3** to make the portal feel like a real multi-site operator tool:

- A **Zone selector (All + Zones)** at the top of `/portal`
- Tenant-scoped APIs updated to accept `zoneId` filters
- Deterministic demo seed to ensure stable KPI numbers
- UI clarification to avoid mixing **offline sensors** vs **offline bays**

## Why this was needed

1) The portal `/portal` had no zone context, so operators couldn’t easily “drill into a zone”.
2) Seeding had become non-deterministic across multiple runs; stale sensors could skew KPIs.
3) The UI previously displayed **offlineSensors** where users expected **offlineBays**, causing confusion (e.g. seeing “offline = 6” while bay states sum implies “offline = 3”).

## What was implemented

### A) Zone selector API

File:

- `app/api/portal/zones/route.ts`

Behavior:

- `GET /api/portal/zones` returns a list:
  - `All Zones` (synthetic row, id = `all`)
  - each real `Zone` with `bayCount`, `siteName`, `address`

### B) Add `zoneId` filtering to portal APIs

Each endpoint now accepts an optional query param:

- `?zoneId=all` (or omitted) = tenant-wide
- `?zoneId=<uuid>` = zone-scoped

Files:

- `app/api/portal/dashboard/route.ts`
  - Bay KPIs + trend now support zone filtering.
- `app/api/portal/map/route.ts`
  - Bay list + meta now support zone filtering.
- `app/api/portal/sensors/route.ts`
  - Sensors list supports zone filtering.
- `app/api/portal/events/route.ts`
  - Events list supports zone filtering (via join to `sensors.zoneId`).

### C) Portal UI: show zone name at top + dropdown

File:

- `app/portal/page.tsx`

Behavior:

- Top headline becomes the selected zone name (or “All Zones”)
- Dropdown persists selection via URL: `/portal?zoneId=...`
- Quick actions propagate `zoneId` when routing to:
  - `/portal/map?zoneId=...`
  - `/portal/sensors?zoneId=...`
  - `/portal/events?zoneId=...`

### D) Deterministic demo seed: 40 bays + 40 sensors distribution

File:

- `prisma/seed.ts`

Behavior (demo data):

- 40 bays exist (A01..A40)
- 40 sensors exist (1 per bay)
- Seeded distribution (bay states):
  - **30 FREE**
  - **7 OCCUPIED**
  - **3 OFFLINE**

Important details:

- The seed now **cleans up old demo sensors/events** before re-inserting (targets sensors by a demo DevEUI prefix).
- “Offline” is achieved by inserting events older than the offline threshold.

### E) KPI clarity: show bay metrics (not sensor metrics) in the `/portal` cards

File:

- `app/portal/page.tsx`

Behavior:

- KPI cards show **Free Bays / Occupied Bays / Offline Bays** (not offline sensors).
- A small line under KPIs shows an explicit reconciliation:
  - `free + occupied + offline + unknown = total`

### F) UX: “Back to Dashboard” visibility on `/portal/sensors`

File:

- `app/portal/sensors/page.tsx`

Behavior:

- Increased top padding so the back button is not hidden behind the fixed header.

### G) Remove duplicate logout

Files:

- `app/components/layout/Header.tsx` already includes logout.
- `app/portal/page.tsx` had a second logout button; it was removed to avoid duplication.

## Verification

### 1) Reseed deterministic demo

```bash
cd /Users/vadimkus/VisionDrive
npm run db:seed
```

### 2) Smoke test: All vs Zone counts (zsh-safe heredoc)

This avoids zsh glob expansion of `?` in URLs.

```bash
cd /Users/vadimkus/VisionDrive
node <<'NODE'
(async () => {
  const login = await fetch('http://localhost:3000/api/auth/login', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ email: 'admin', password: 'admin5' }),
  })
  const cookie = login.headers.get('set-cookie') || ''

  const zonesRes = await fetch('http://localhost:3000/api/portal/zones', { headers: { cookie } })
  const zonesJson = await zonesRes.json()
  const zones = zonesJson.zones || []
  console.log('zones:', zones.map((z) => ({ id: z.id, name: z.name, bays: z.bayCount })))

  const firstZone = zones.find((z) => z.id && z.id !== 'all')
  if (!firstZone) return

  const dashAll = await (await fetch('http://localhost:3000/api/portal/dashboard?zoneId=all', { headers: { cookie } })).json()
  const dashZ = await (await fetch(`http://localhost:3000/api/portal/dashboard?zoneId=${encodeURIComponent(firstZone.id)}`, { headers: { cookie } })).json()

  const ka = dashAll.kpis || {}
  const kz = dashZ.kpis || {}
  const sumAll = (ka.freeBays || 0) + (ka.occupiedBays || 0) + (ka.offlineBays || 0) + (ka.unknownBays || 0)
  const sumZ = (kz.freeBays || 0) + (kz.occupiedBays || 0) + (kz.offlineBays || 0) + (kz.unknownBays || 0)

  console.log('dashboard all:', { totalBays: ka.totalBays, free: ka.freeBays, occupied: ka.occupiedBays, offline: ka.offlineBays, unknown: ka.unknownBays, sum: sumAll })
  console.log('dashboard zone:', { zoneId: firstZone.id, totalBays: kz.totalBays, free: kz.freeBays, occupied: kz.occupiedBays, offline: kz.offlineBays, unknown: kz.unknownBays, sum: sumZ })
})().catch((e) => { console.error(e); process.exit(1) })
NODE
```

Expected (with seeded demo data):

- total = 40
- free = 30
- occupied = 7
- offline = 3
- unknown = 0

## Notes / known limitations

- `offlineSensors` can still be higher than `offlineBays` if there are sensors not bound to bays or old sensors remaining from earlier experiments. The dashboard cards now focus on **bay truth** to avoid confusion.



