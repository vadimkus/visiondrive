# 11.3 Phase C — Operator Portal MVP (customer view)

This phase delivers a working **tenant-scoped operator portal** (customer view) with the key pages needed for MVP operations.

## Goal

- `/portal` dashboard: KPI cards + trend + alerts summary (tenant-scoped)
- `/portal/map`: bay colors (Green/Red/Gray) + last update + confidence
- `/portal/sensors`: list + details (health + events + maintenance notes)
- `/portal/events`: time-series viewer with filters + CSV export
- `/portal/admin`: user management + tenant settings (threshold thresholds)
- Map rendering (Portal): Mapbox GL JS with bay polygons/markers + clustering + layer toggles (bays/sensors/zones)

## What was implemented

### Data model extensions

File: `prisma/schema.prisma`

- `tenant_settings`
  - one row per tenant with thresholds JSON:
    - `offlineMinutes`
    - `lowBatteryPct`
    - `staleEventMinutes`
- `maintenance_notes`
  - operator notes per sensor (with author + timestamp)

Seeding:

File: `prisma/seed.ts`

- ensures `tenant_settings` exists for the default tenant with reasonable defaults.

### Tenant-scoped RBAC groundwork

Files:

- `lib/auth.ts`: login now prefers the **membership role** for the user’s default tenant (if present)
- `app/api/auth/me/route.ts`: `/api/auth/me` returns effective role + `tenantId`
- `lib/portal/session.ts`: shared helper for portal APIs to require a valid session and tenant.

## Portal APIs (tenant-scoped)

- `GET /api/portal/dashboard`
  - KPIs + `time_bucket('1 hour')` trend over last 24h
- `GET /api/portal/map`
  - bay status + confidence based on freshness and battery
- `GET /api/portal/sensors`
  - list sensors with health score and basic metadata
- `GET /api/portal/sensors/:id`
  - sensor details + recent events + maintenance notes
- `POST /api/portal/sensors/:id/notes`
  - add a maintenance note
- `GET /api/portal/events`
  - time-series list with filters
  - supports CSV export via `?format=csv`
- `GET/POST /api/portal/admin/settings`
  - view/update tenant thresholds (MASTER_ADMIN / CUSTOMER_ADMIN)
- `GET/POST /api/portal/admin/users`
  - list/create tenant users (MASTER_ADMIN / CUSTOMER_ADMIN)

## Portal UI pages

- `/portal` (dashboard)
- `/portal/map` (Mapbox map: bay polygons + sensors clustering + overlays)
- `/portal/sensors` (fleet list)
- `/portal/sensors/[id]` (detail + events + notes)
- `/portal/events` (filters + CSV export)
- `/portal/admin` (thresholds + users)
- `/portal/calibration` (admin tool: drag & fix sensor placement)

## Verification checklist

1) Login

- `POST /api/auth/login` (`admin` / `admin5`)
- Confirm `/api/auth/me` returns:
  - `tenantId`
  - `role` (membership role)

2) API checks

- `GET /api/portal/dashboard` → 200
- `GET /api/portal/map` → 200
- `GET /api/portal/sensors` → 200
- `GET /api/portal/events?limit=10` → 200
- `GET /api/portal/events?format=csv&limit=10` → downloads CSV
- `GET /api/portal/admin/settings` → 200 for admin roles
- `GET /api/portal/admin/users` → 200 for admin roles

3) UI checks

- Navigate to `/portal`
- Open `/portal/map`, `/portal/sensors`, `/portal/events`
- Add a note on `/portal/sensors/[id]`
- Update thresholds on `/portal/admin`

## Notes / follow-ups

- Map rendering is implemented with Mapbox GL JS (polygons + clustering + toggles). Calibration tooling is available for manual sensor placement correction.
- “Alerts summary” on dashboard currently aggregates offline/battery/dead-letters; Phase 11.4 will add a real alerts pipeline + queue workflow.
- Follow-up work (zone selector + deterministic seed + KPI clarity) is documented in `docs/11.3.1-zone-selector-and-demo-seed.md`.
- Mapbox map implementation: `docs/11.3.2-mapbox-portal-map.md`
- Map UX (select/highlight/filters): `docs/11.3.3-map-interactions-filters-selection.md`
- Dubai Pulse zones import + overlay: `docs/11.3.4-dubai-pulse-zones-import.md`
- Sensor calibration tooling: `docs/11.3.5-map-calibration-sensors.md` and `docs/11.3.6-calibration-ux-all-sensors-installed-only.md`


