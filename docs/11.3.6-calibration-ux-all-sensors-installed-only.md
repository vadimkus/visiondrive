# 11.3.6 Calibration UX upgrades — all sensors overlay, installed-only=40, stable map

This document captures upgrades to the Calibration workflow after **11.3.5**.

## Goals

- Calibration page must be usable for real field work:
  - show **all sensors on the map** for visual reference
  - show **installed sensors only** by default (expected **40**, not the extra “unassigned” sensors)
  - allow selecting sensors via list **or clicking a dot on the map**
  - prevent the map from disappearing during saves/refreshes
  - make the list height match the map

## Changes

### A) Calibration shows installed sensors only (40) by default

Files:

- `app/api/portal/admin/sensors/route.ts`
- `app/portal/calibration/page.tsx`

Behavior:

- Admin sensors list endpoint now supports:
  - `installedOnly=1` → only sensors with `bayId IS NOT NULL`
  - `installedOnly=0` → includes “unassigned” extras
- Calibration UI defaults to **Installed only** and exposes a toggle.

### B) Calibration “All sensors on map” overlay

File:

- `app/portal/calibration/page.tsx`

Behavior:

- Adds a Mapbox GeoJSON source with **all sensors** as points.
- Renders:
  - blue dots for all sensors
  - a bold ring for the selected sensor
- Clicking a dot selects that sensor in the UI.

### C) Calibration list height matches map height

File:

- `app/portal/calibration/page.tsx`

Behavior:

- Left list uses the same max height as the map (`720px/780px`) so it visually matches the map column.

### D) Fix “save causes map to disappear”

File:

- `app/portal/calibration/page.tsx`

Root cause:

- A single `loading` state replaced the entire page with a “Loading…” screen during refresh, unmounting the map container.

Fix:

- Split into:
  - `bootLoading` (first page load only)
  - `listLoading` (refresh list without unmounting map)

### E) Portal map reflects calibration changes

Files:

- `app/api/portal/map/route.ts` (returns `sensorLat/sensorLng`)
- `app/portal/map/MapboxMap.tsx` (sensor layer uses sensor coords)

Behavior:

- Sensor markers on `/portal/map` now use:
  - `sensorLat/sensorLng` when present
  - fallback to bay lat/lng otherwise

## Verification checklist

1) Open:

- `/portal/calibration`

2) Confirm:

- “Installed only” ON → shows **40**
- Toggle OFF → shows **43**
- “Show all on map” ON → sensor dots visible
- Click a dot → selects sensor
- Drag marker + Save → map stays visible (no disappear)

3) Confirm portal map uses sensor coords:

- Calibrate a sensor to a visibly different spot
- Open `/portal/map` and click **Refresh** → sensor marker moves


