# 11.1 Phase A — Foundation (multi-tenant + data model)

This document describes what we implemented for Phase **11.1** and how to reproduce/verify it.

## Goal

Create an enterprise-ready foundation:

- Multi-tenant model (customers/buildings) + memberships/roles
- Core parking entities (sites/zones/bays/sensors/gateways)
- Timescale-ready event storage (`sensor_events` hypertable)
- Audit log table
- Auth includes `tenantId` so every API can enforce tenant scoping server-side

## What changed

### Database schema

File: `prisma/schema.prisma`

- **New enums**
  - `UserRole`: added `MASTER_ADMIN`, `CUSTOMER_ADMIN`, `CUSTOMER_OPS`, `CUSTOMER_ANALYST`
  - `TenantStatus`, `MembershipStatus`, `ZoneKind`, `AssetStatus`, `SensorType`, `GatewayBackhaul`, `SensorEventKind`
- **New models**
  - `Tenant` → `tenants`
  - `TenantMembership` → `tenant_memberships`
  - `Site` → `sites`
  - `Zone` → `zones`
  - `Bay` → `bays`
  - `Sensor` → `sensors`
  - `Gateway` → `gateways`
  - `SensorEvent` → `sensor_events` (timeseries)
  - `AuditLog` → `audit_logs`
- **User updates**
  - added `defaultTenantId` on `users`

### Seeding

File: `prisma/seed.ts`

- Ensures a default tenant exists:
  - slug: `visiondrive`
  - name: `VisionDrive (Default)`
- Ensures the admin user exists and is a `MASTER_ADMIN`
- Ensures a `tenant_memberships` row links `admin` to the default tenant
- Creates the Timescale hypertable + indexes:
  - `create_hypertable('sensor_events', 'time', if_not_exists => TRUE)`
  - indexes:
    - `("tenantId", time)`
    - `("sensorId", time)`
    - `("gatewayId", time)`

### Auth payload includes tenantId

Files:

- `lib/auth.ts`
  - JWT now includes `tenantId` (from `users.defaultTenantId`)
  - login response includes `tenantId`
- `app/api/auth/me/route.ts`
  - `/api/auth/me` returns `tenantId`

## Commands to run

From `VisionDrive/`:

- Apply schema:
  - `npm run db:push`
- Seed base data + hypertable:
  - `npm run db:seed`

## Verification checklist

### 1) Login returns tenantId

- POST `http://localhost:3000/api/auth/login` with:
  - `email=admin`
  - `password=admin5`
- Expect:
  - `user.role = "MASTER_ADMIN"`
  - `user.tenantId` present

### 2) /me returns tenantId

- GET `http://localhost:3000/api/auth/me` with auth cookie from login
- Expect:
  - `success: true`
  - `user.tenantId` present

### 3) Timescale hypertable created

Seed logs should include:

- `✅ Ensured sensor_events hypertable + indexes`

## Notes / gotchas

- Timescale best practice is to store time columns as `TIMESTAMPTZ` (we updated `SensorEvent.time` + `createdAt` accordingly).
- Timescale hypertables require the **partitioning column** (`time`) to be part of the **primary key** if you want uniqueness/PK guarantees. We used a composite id:
  - `@@id([id, time])`

## Next step

Proceed to **11.2 Phase B**: simulated ingestion (`/api/replay/upload`, `/api/replay/run`, decoder bench, dead-letter UI).


