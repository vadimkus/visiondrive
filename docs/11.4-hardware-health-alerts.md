# 11.4 — Hardware Health + Alerts System (Week 3–4)

This phase adds an **operator-grade health and alerting layer** on top of the existing sensor data model.

## What we shipped

- **Health metrics**
  - Days-in-use (from `sensors.installDate`)
  - Battery drain estimate (from `sensor_events.batteryPct`, last 7 days)
  - Signal quality (avg RSSI/SNR, last 24h)
  - Flapping detection (occupancy state changes in a rolling window)
  - Updated sensor list health scoring to include these signals

- **Alerts pipeline**
  - `SENSOR_OFFLINE`, `LOW_BATTERY`, `POOR_SIGNAL`, `FLAPPING`, `DECODE_ERRORS`
  - Stored in `alerts` + action history in `alert_events`
  - SLA due time computed based on severity (CRITICAL/WARNING/INFO)
  - Manual “Run Scan” endpoint (server-side)

- **Alerts UI**
  - `/portal/alerts`: queue with filters + SLA timer + actions (ack/assign-to-me/resolve)
  - Audit trail panel per alert (from `alert_events`)
  - Sensor detail page shows active alerts + key health metrics

## Database changes

Added models/enums in `prisma/schema.prisma`:
- `Alert`, `AlertEvent`
- enums: `AlertType`, `AlertSeverity`, `AlertStatus`

Apply:

```bash
cd /Users/vadimkus/VisionDrive
npm run db:push
```

## Key files

- **Schema**
  - `prisma/schema.prisma`

- **Alert logic**
  - `lib/alerts.ts`

- **APIs**
  - `app/api/portal/alerts/route.ts` (list)
  - `app/api/portal/alerts/run/route.ts` (run scan)
  - `app/api/portal/alerts/[id]/route.ts` (ack/assign/resolve)
  - `app/api/portal/alerts/[id]/events/route.ts` (audit trail)

- **UI**
  - `app/portal/alerts/page.tsx`
  - `app/portal/alerts/AlertsPageClient.tsx`

## Thresholds / tuning

Stored in `tenant_settings.thresholds` (JSON). Defaults seeded in `prisma/seed.ts`:

- `offlineMinutes`, `lowBatteryPct`, `staleEventMinutes`
- `poorRssiThreshold`, `poorSnrThreshold`, `signalLookbackHours`, `signalMinSamples`
- `flappingWindowMinutes`, `flappingMaxChanges`
- `deadLettersWindowHours`, `deadLettersWarning`, `deadLettersCritical`
- `slaHoursCritical`, `slaHoursWarning`, `slaHoursInfo`

## How to verify

1. Reseed demo data (optional):

```bash
cd /Users/vadimkus/VisionDrive
npm run db:seed
```

2. Open `/portal/alerts` and click **Run Scan**
   - You should see alerts for any sensors that are offline / low battery / poor signal / flapping.
3. Open a sensor detail page
   - Confirm health metrics show (days in use, battery drain, RSSI/SNR, flapping)
   - Confirm Active Alerts list displays and links to Alerts page filtered by that sensor.

## Notes / limitations

- The scan is currently **manual** (button/API). This is intentional while we’re still in simulated ingestion mode.
- Once we add real LoRaWAN uplinks, we’ll trigger targeted evaluation per affected sensor and/or add a Vercel Cron job.



