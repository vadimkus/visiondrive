# 11.2 Phase B — Simulated Data Ingestion (gateway not required)

This phase lets us build and demo the portal **before gateways arrive** by uploading and replaying “uplink logs”.

## Goal

- Upload JSON/CSV event logs into a **staging area**
- Validate + dead-letter invalid rows
- Replay staged events into `sensor_events` in **small batches** (serverless-safe)

## Database tables (Phase 11.2)

Defined in `prisma/schema.prisma`:

- `ingest_files`: one upload = one file record (counts, min/max times, status)
- `ingest_events`: validated staged events (ordered by `seq`)
- `ingest_dead_letters`: invalid rows with reason + raw data
- `replay_jobs`: replay progress (cursor + processed count)

## API endpoints

### 0) Decoder bench (preview + save)

Files:

- `app/api/replay/bench/preview/route.ts`
- `app/api/replay/bench/save/route.ts`

UI:

- `/portal/replay` → **Decoder Bench**

Preview:

- `POST /api/replay/bench/preview`
- Body: `{ sensorType, rawPayload }`
- Returns: `{ decoded, warnings }`

Save:

- `POST /api/replay/bench/save`
- Body: `{ devEui, sensorType, rawPayload, time? }`
- Behavior:
  - ensures `sensors` row exists for the `devEui`
  - inserts a row into `sensor_events` immediately (no staging required)

### 1) Upload

File: `app/api/replay/upload/route.ts`

- `POST /api/replay/upload`
- Auth required (uses JWT cookie `authToken`)
- Uses `tenantId` from the token (must be set on the user as `defaultTenantId`)

Supports:

- JSON body:
  - `{ filename?: string, source?: string, events: UploadEvent[] }`
  - or a raw array `UploadEvent[]`
- Multipart form:
  - `file` (JSON or CSV)

Validation:

- Requires:
  - time (`time` or `timestamp` or `ts`)
  - `devEui` (or `deveui` or `deviceEui`)
- Invalid rows go to `ingest_dead_letters`

### 2) Replay run (batched)

File: `app/api/replay/run/route.ts`

- `POST /api/replay/run`
- Body: `{ fileId, jobId?, speed?, batchSize? }`

Behavior:

- Creates/updates a `replay_jobs` row
- Fetches the next batch of `ingest_events` after cursor
- Inserts events into `sensor_events`
- Auto-creates missing `sensors` (by `devEui`) and optional `gateways` (by `gatewaySerial`)
- Update `sensors.lastSeen` and `sensors.batteryPct`
- Returns job progress; repeat calls until status = `DONE`

## Quick local test

1) Ensure DB is up-to-date:

- `npm run db:push`
- `npm run db:seed`

2) Login to get cookie:

- `POST /api/auth/login` (`admin` / `admin5`)

3) Upload sample:

Upload 2 events as JSON to `POST /api/replay/upload`, then call `POST /api/replay/run` until `DONE`.

## Notes / limitations (current MVP)

- Replay “speed” is stored on the job but does not time-warp in serverless; clients call `/run` repeatedly.
- CSV parsing is minimal (good enough for early logs). We can upgrade later.
- Decoder logic is MVP:
  - JSON payloads are parsed as-is
  - HEX payloads use a small placeholder decoder (parking occupancy/battery) until device-specific decoders are implemented
- Dead-letter viewer UI exists at `/portal/replay` → **Dead Letters**


