# 11.3.2 Map rendering (Portal) — Mapbox GL JS (bays/sensors/zones)

This document implements the **Mapbox GL JS** version of `/portal/map` with:

- Bay polygons/markers (GeoJSON)
- Sensor markers with **clustering**
- Layer toggles (bays / sensors / zone boundary)

## What changed

### Dependencies + CSS

- Added dependency: `mapbox-gl`
- Global CSS import:
  - `app/globals.css` → `@import 'mapbox-gl/dist/mapbox-gl.css';`

### Demo geo data (so the map has something to render)

File: `prisma/seed.ts`

- Demo site center coordinates are set.
- Demo zone gets a rectangle boundary GeoJSON (`zones.geojson`).
- Demo bays get:
  - `lat/lng`
  - a small rectangle polygon per bay (`bays.geojson`)

### Map API includes geojson + center

File: `app/api/portal/map/route.ts`

- Adds to `meta`:
  - `centerLat`, `centerLng`
  - `zoneGeojson`
- Adds to each map item:
  - `geojson` (bay polygon)
  - still includes `lat/lng` for point fallback + sensors

### Portal UI map renderer

Files:

- `app/portal/map/MapboxMap.tsx`
  - Mapbox map with:
    - **zones** fill + outline
    - **bays** polygon fill + outline (and point fallback)
    - **sensors** clustered layer + unclustered points
    - Clickable bays with popup (state/confidence/last seen/sensor/battery)
    - Layer toggles (checkboxes)
- `app/portal/map/page.tsx`
  - Replaces the old “Bay Grid placeholder” with the Mapbox renderer while keeping the details panel.

## Environment variable required

You must set:

- `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN`

Locally (example):

```bash
export NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN="pk.XXXX..."
```

On Vercel:

- Add `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN` to the Project → Environment Variables.

If the token is missing, the page shows a friendly warning instead of crashing.

## Verification checklist

1) Seed geo data:

```bash
cd /Users/vadimkus/VisionDrive
npm run db:seed
```

2) Open:

- `/portal/map`
- Toggle layers (bays/sensors/zones)
- Click a bay polygon to see the popup
- Click a sensor cluster to zoom in

3) Confirm the API contains geo data:

```bash
cd /Users/vadimkus/VisionDrive
node <<'NODE'
(async () => {
  const login = await fetch('http://localhost:3000/api/auth/login', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ email: 'admin', password: 'admin5' }),
  })
  const cookie = login.headers.get('set-cookie') || ''
  const map = await (await fetch('http://localhost:3000/api/portal/map?zoneId=all', { headers: { cookie } })).json()
  console.log('meta has zoneGeojson:', !!map.meta?.zoneGeojson)
  console.log('first item has bay geojson:', !!map.items?.[0]?.geojson)
})().catch((e) => { console.error(e); process.exit(1) })
NODE
```

## Notes / next improvements

- When real deployments arrive, you’ll store **true bay polygons** (surveyed) rather than demo rectangles.
- Next phase can add:
  - “hover highlight” and selection syncing with the details list
  - status legend + filtering (only offline, only unknown, etc.)
  - Mapbox style customization to match the Dribbble operator portal aesthetic



