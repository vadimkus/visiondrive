// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for drivers and app users
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String?  @unique
  name          String
  passwordHash  String?
  role          UserRole @default(DRIVER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  reservations  Reservation[]
  payments      Payment[]
  favorites     Favorite[]
  
  @@map("users")
}

enum UserRole {
  DRIVER
  ADMIN
  PARTNER_ADMIN
  GOVERNMENT_ADMIN
}

// Parking location model
model ParkingLocation {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String   @default("Dubai")
  latitude    Float
  longitude   Float
  description String?
  
  // Location metadata
  type        LocationType @default(COMMERCIAL)
  isActive    Boolean      @default(true)
  isPublic    Boolean      @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  spaces      ParkingSpace[]
  sensors     Sensor[]
  gateways    Gateway[]
  reservations Reservation[]
  analytics   LocationAnalytics[]
  favorites   Favorite[]
  partnerId   String?
  partner     Partner?  @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  
  @@map("parking_locations")
}

enum LocationType {
  COMMERCIAL
  RESIDENTIAL
  MUNICIPAL
  MALL
  OFFICE
  HOSPITAL
  HOTEL
  OTHER
}

// Parking space model
model ParkingSpace {
  id          String   @id @default(cuid())
  locationId  String
  spaceNumber String
  floor       Int?     @default(1)
  zone        String?
  
  // Space properties
  isAccessible Boolean @default(false)
  isReserved   Boolean @default(false)
  isAvailable  Boolean @default(true)
  isActive     Boolean @default(true)
  
  // Pricing
  basePrice    Float?
  pricePerHour Float?
  currency     String  @default("AED")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  location     ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  sensor       Sensor?
  reservations Reservation[]
  occupancy    OccupancyRecord[]
  
  @@unique([locationId, spaceNumber])
  @@map("parking_spaces")
}

// Sensor model for LW009-SM sensors
model Sensor {
  id          String   @id @default(cuid())
  locationId  String
  spaceId     String?  @unique
  
  // Sensor properties
  sensorType  String   @default("LW009-SM")
  macAddress  String   @unique
  isActive    Boolean  @default(true)
  batteryLevel Int?
  lastSeen    DateTime?
  
  // Configuration
  detectionMode String @default("DUAL") // DUAL mode for LW009-SM
  sensitivity   Int?    @default(5)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  location    ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  space       ParkingSpace?   @relation(fields: [spaceId], references: [id], onDelete: SetNull)
  gatewayId   String?
  gateway     Gateway?        @relation(fields: [gatewayId], references: [id], onDelete: SetNull)
  readings    SensorReading[]
  
  @@map("sensors")
}

// Gateway model for RAK7289CV2 gateway
model Gateway {
  id          String   @id @default(cuid())
  locationId  String
  
  // Gateway properties
  gatewayType String   @default("RAK7289CV2")
  serialNumber String  @unique
  macAddress  String   @unique
  
  // Connectivity
  lteEnabled  Boolean  @default(true)
  wifiEnabled Boolean  @default(false)
  lorawanEnabled Boolean @default(true)
  
  // Status
  isOnline    Boolean  @default(false)
  lastSeen    DateTime?
  firmwareVersion String?
  
  createdAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  location    ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  sensors    Sensor[]
  
  @@map("gateways")
}

// Sensor reading model for real-time data
model SensorReading {
  id          String   @id @default(cuid())
  sensorId    String
  
  // Reading data
  isOccupied  Boolean
  timestamp   DateTime @default(now())
  signalStrength Int?
  batteryLevel Int?
  
  // Metadata
  rawData     Json?
  
  createdAt   DateTime @default(now())
  
  // Relations
  sensor      Sensor   @relation(fields: [sensorId], references: [id], onDelete: Cascade)
  
  @@index([sensorId, timestamp])
  @@index([timestamp])
  @@map("sensor_readings")
}

// Occupancy record for analytics
model OccupancyRecord {
  id          String   @id @default(cuid())
  spaceId     String
  locationId  String
  
  // Occupancy data
  isOccupied  Boolean
  startTime   DateTime
  endTime     DateTime?
  duration    Int?     // Duration in minutes
  
  // Vehicle info (if available)
  vehiclePlate String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  space       ParkingSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@index([spaceId, startTime])
  @@index([locationId, startTime])
  @@map("occupancy_records")
}

// Reservation model
model Reservation {
  id          String   @id @default(cuid())
  userId      String
  locationId  String
  spaceId     String?
  
  // Reservation details
  startTime   DateTime
  endTime     DateTime
  status      ReservationStatus @default(PENDING)
  
  // Pricing
  price       Float
  currency    String  @default("AED")
  isPaid      Boolean @default(false)
  
  // Metadata
  notes       String?
  cancelledAt DateTime?
  cancelledReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  location    ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  space       ParkingSpace?   @relation(fields: [spaceId], references: [id], onDelete: SetNull)
  payment     Payment?
  
  @@index([userId, startTime])
  @@index([locationId, startTime])
  @@index([status])
  @@map("reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

// Payment model
model Payment {
  id            String   @id @default(cuid())
  userId        String
  reservationId String?  @unique
  
  // Payment details
  amount        Float
  currency      String   @default("AED")
  status        PaymentStatus @default(PENDING)
  method        PaymentMethod
  
  // Transaction info
  transactionId String?  @unique
  provider      String?   // Payment provider name
  providerData  Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservation   Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  
  @@index([userId, createdAt])
  @@index([status])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  APPLE_PAY
  GOOGLE_PAY
  MOBILE_WALLET
  OTHER
}

// Favorite locations for users
model Favorite {
  id          String   @id @default(cuid())
  userId      String
  locationId  String
  
  createdAt   DateTime @default(now())
  
  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  location    ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@unique([userId, locationId])
  @@map("favorites")
}

// Analytics model for location-level data
model LocationAnalytics {
  id          String   @id @default(cuid())
  locationId  String
  
  // Time period
  date        DateTime @db.Date
  hour        Int?     // 0-23
  
  // Metrics
  totalSpaces       Int
  occupiedSpaces    Int
  availableSpaces   Int
  reservationsCount Int       @default(0)
  revenue           Float     @default(0)
  
  // Turnover metrics
  averageDuration   Int?      // Average parking duration in minutes
  turnoverRate      Float?    // Spaces turned over per hour
  
  // Traffic metrics
  entryCount        Int       @default(0)
  exitCount         Int       @default(0)
  averageSearchTime Int?      // Average search time in minutes
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  location    ParkingLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@unique([locationId, date, hour])
  @@index([locationId, date])
  @@map("location_analytics")
}

// Partner/Client model for B2B relationships
model Partner {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  
  // Partner details
  type        PartnerType
  status      PartnerStatus @default(ACTIVE)
  
  // Business info
  companyName String?
  taxId       String?
  address     String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  locations   ParkingLocation[]
  
  @@map("partners")
}

enum PartnerType {
  COMMERCIAL
  MALL
  MUNICIPALITY
  RTA
  RESIDENTIAL
  OTHER
}

enum PartnerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

